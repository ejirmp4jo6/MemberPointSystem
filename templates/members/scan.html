{% extends "base.html" %}
{% block title %}店員累點{% endblock %}
{% block content %}
{% load static %}

<div class="cardish">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5 class="mb-0">店員累點</h5>
    <span class="badge-soft">只限店員</span>
  </div>

  <!-- 掃描區 -->
  <div id="qr-box" class="mb-3" style="display:block;">
    <div id="qr-reader" style="width:100%; max-width:480px; margin:0 auto;"></div>
  </div>

  <div id="bc-box" class="mb-3" style="display:none;">
    <div id="bc-reader" style="width:100%; max-width:480px; margin:0 auto; background:#000; color:#fff; border-radius:8px;">
      <div class="p-2 text-center">相機啟動中…若無畫面請切到背面鏡頭</div>
      <canvas class="w-100" id="bc-canvas"></canvas>
    </div>
    <div class="d-flex gap-2 justify-content-center mt-2">
      <button class="btn btn-sm btn-outline-secondary" id="bc-swap">切換鏡頭</button>
    </div>
  </div>

  <!-- 表單 -->
  <form method="post" action="{% url 'earn_points' %}" class="row g-3">
    {% csrf_token %}
    <div class="col-12">
      <label class="form-label">會員 QRCode</label>
      <div class="input-group">
        <input name="barcode_token" id="token-input" class="form-control" placeholder="掃描或貼上 QRCode" required>
        <button class="btn btn-outline-secondary" type="button" id="open-scanner" aria-label="開啟相機掃描">
          <i class="bi bi-camera"></i>
        </button>
      </div>
      <div class="form-text">點右邊相機圖示即可開啟鏡頭掃描。</div>
    </div>

    <div class="btn-group w-100 mb-2" role="group" aria-label="加扣點">
      <input type="radio" class="btn-check" name="mode" id="mode-earn" value="earn" checked>
      <label class="btn btn-outline-success" for="mode-earn">加點</label>

      <input type="radio" class="btn-check" name="mode" id="mode-deduct" value="deduct">
      <label class="btn btn-outline-danger" for="mode-deduct">扣點</label>
    </div>

    <div class="col-6">
      <label id="amount-label" class="form-label">消費金額（TWD）</label>
      <input name="amount_twd" id="amount-input" type="number" min="0" step="1" class="form-control" required>
      <div class="d-flex justify-content-between align-items-center mt-1">
        <small id="deduct-hint" class="text-muted">本次可折抵上限：—</small>
        <button type="button" id="btn-redeem-all"
                class="btn btn-outline-danger btn-sm" disabled>全部折抵</button>
      </div>
      <input type="hidden" id="member-api-url" value="{% url 'api_member_by_token' %}">
      <input type="hidden" id="redeem-per-point" value="{{ redeem_per_point }}">
    </div>

    <div class="col-12">
      <label class="form-label">備註（可選）</label>
      <input name="note" class="form-control" placeholder="例如：外帶咖啡兩杯">
    </div>
    <div class="col-12 d-flex gap-2">
      <button type="submit" class="btn btn-brand">
      <i class="bi bi-send me-1"></i> 送出
      </button>
      <a class="btn btn-outline-secondary" href="{% url 'scan_page' %}">清空重掃</a>
    </div>
  </form>
</div>

<script src="{% static 'js/scan.js' %}"></script>
<script src="{% static 'js/scan_typeSwitch.js' %}"></script>
<script src="{% static 'js/scan_redeem_hint.js' %}"></script>
{% endblock %}
{% block app_tabs %}{% endblock %}