{% extends "base.html" %}
{% block title %}黑卡{% endblock %}
{% block content %}
<div class="row gy-3">

  <!-- 黑卡 -->
  <div class="col-12">
    <div class="card-black">
      <div class="d-flex justify-content-between align-items-start">
        <div class="brand">LOUISA COFFEE</div>
        <div class="small text-white-50">VIP CARD</div>
      </div>

      <!-- 卡號（直接用 token；若想加空格可做 template filter，見下方進階） -->
      <div class="number">{{ member.barcode_token }}</div>

      <div class="meta">
        <div>
          <span class="label">Card Holder</span>
          <div>{{ member.display_name|default:member.user.username }}</div>
        </div>
        <div>
          <span class="label">Points</span>
          <div>{{ member.points }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 行銷橫條 -->
  <div class="col-12">
    <div class="ribbon">
      <div class="text-muted">會員咖啡飲品第二杯 5 折 與 早餐（11 點前）優惠</div>
      <a class="btn btn-sm btn-outline-dark" href="#" role="button">查看優惠</a>
    </div>
  </div>

  <!--QRCode區-->>
  {% load static %}

  <!-- 兩顆選項按鈕 -->
  <div class="col-12">
    <div class="d-flex gap-2 action-row">
      <button class="btn btn-warning flex-fill" id="tab-qr" data-type="qr">會員 QRCode</button>
      <button class="btn btn-outline-secondary flex-fill" id="tab-barcode" data-type="barcode">會員條碼</button>
    </div>
  </div>


  <!-- 圖片展示區 -->
  <div class="col-12">
    <div class="qr-box" id="code-box">
      <!-- 預設顯示 QR；JS 會切換 src -->
      <img id="code-img" src="{% url 'qrcode_image' %}" alt="會員代碼" class="img-fluid" style="max-width:320px">
    </div>
    <div class="d-flex justify-content-center gap-2 mt-2">
      <a id="download-link" class="btn btn-sm btn-outline-dark" href="{% url 'qrcode_image' %}" download="member_qr.png">下載圖片</a>
      <button id="copy-token" class="btn btn-sm btn-outline-secondary">複製卡號</button>
    </div>
    <p class="text-muted small text-center mt-2">卡號：<span id="token-text">{{ member.barcode_token }}</span></p>
  </div>

  <script>
    (function(){
      const tabQr = document.getElementById('tab-qr');
      const tabBc = document.getElementById('tab-barcode');
      const img   = document.getElementById('code-img');
      const link  = document.getElementById('download-link');
      const copy  = document.getElementById('copy-token');

      function setActive(type){
        const isQR = type === 'qr';
        img.src  = isQR ? "{% url 'qrcode_image' %}" : "{% url 'barcode_image' %}";
        link.href = img.src;
        link.download = isQR ? "member_qr.png" : "member_barcode.png";

        tabQr.classList.toggle('btn-warning', isQR);
        tabQr.classList.toggle('btn-outline-secondary', !isQR);
        tabBc.classList.toggle('btn-warning', !isQR);
        tabBc.classList.toggle('btn-outline-secondary', isQR);
      }


      tabQr.addEventListener('click', () => setActive('qr'));
      tabBc.addEventListener('click', () => setActive('barcode'));
      setActive('qr'); // 預設 QR

      copy.addEventListener('click', async () => {
        const text = document.getElementById('token-text').textContent.trim();
        try { await navigator.clipboard.writeText(text); alert('已複製卡號'); }
        catch(e){ alert('複製失敗，請手動選取複製'); }
      });
    })();
  </script>

  
  <!-- 最近交易（保留） -->
  <div class="col-12">
    <div class="cardish">
      <h6 class="mb-3">消費記錄</h6>
      <div class="table-responsive">
        <table class="table table-clean align-middle">
          <thead><tr><th>時間</th><th>說明</th><th class="text-end">點數</th></tr></thead>
          <tbody>
            {% for t in txns %}
            <tr>
              <td>{{ t.created_at|date:"Y-m-d H:i" }}</td>
              <td class="text-muted">{{ t.note }}</td>
              <td class="text-end">
                <strong class="{% if t.amount > 0 %}text-success{% else %}text-danger{% endif %}">
                  {% if t.amount > 0 %}+{% endif %}{{ t.amount }}
                </strong>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="text-muted">尚無交易</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- 底部導覽（示意） -->
<div class="bottom-tabs d-flex mt-3 rounded-top">
  <div class="tab">黑卡</div>
  <div class="tab">點餐</div>
  <div class="tab">消費記錄</div>
  <div class="tab">購物車</div>
  <div class="tab">個人</div>
</div>
{% endblock %}
